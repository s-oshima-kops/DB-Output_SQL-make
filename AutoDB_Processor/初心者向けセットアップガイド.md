# 🔰 初心者向けセットアップガイド

## 📋 はじめに
このガイドでは、**端末マスタ管理半自動化ツール**を初めて使用する方でも簡単にセットアップできるよう、手順を詳しく説明します。

**⚠️ 重要**: 分からないことがあれば、無理をせずにシステム管理者に相談してください。

---

## 🛠 必要な準備

### 1. 必要なソフトウェア
- ✅ **Microsoft Excel** (VBAマクロが有効)
- ✅ **Oracle SQL\*Plus** (データベース接続用)
- ✅ **Windows OS** (バッチファイル実行用)

### 2. 権限・アクセス
- ✅ Oracleデータベースへの読み取り権限
- ✅ 共有フォルダへの読み書き権限
- ✅ Excelマクロの実行権限

---

## 📁 ファイル配置

### ステップ1: フォルダ構成の確認
以下のような構成になっていることを確認してください：

```
AutoDB_Processor/
├── export_terminal.bat              ← バッチファイル
├── export_terminal.sql              ← SQLファイル
├── VBA_Code_for_import_master.vbs   ← VBAコード
├── config.txt                       ← 設定ファイル
├── templates/
│   └── sql_template.txt             ← SQLテンプレート
├── AutoDB_output/                   ← 出力フォルダ（空でOK）
└── sample_hearing_sheet.txt         ← サンプルファイル
```

**確認方法**: エクスプローラーでフォルダを開き、上記のファイルがあることを確認

---

## ⚙️ 設定変更（重要）

### ステップ2: データベース接続設定【最重要】
**ファイル**: `export_terminal.bat`

#### 📝 修正手順
1. `export_terminal.bat` を **右クリック** → **編集** でファイルを開く
2. **★★★で囲まれた設定部分** を探す
3. **<<<>>>で囲まれた部分** を実際の値に置き換える

#### 🔍 修正箇所の詳細

**修正前**:
```batch
set DB_USER=<<<your_username>>>
set DB_PASS=<<<your_password>>>  
set DB_CONNECT=<<<your_server:1521/your_service>>>
```

**修正後の例**:
```batch
set DB_USER=terminal_user
set DB_PASS=mypassword123
set DB_CONNECT=dbserver01:1521/ORCL
```

#### 📋 各設定の意味と反映される処理
| 設定項目 | 意味 | この設定が影響する処理 |
|---------|------|---------------------|
| `DB_USER` | データベースのログインユーザー名 | Oracle接続時の認証 |
| `DB_PASS` | データベースのパスワード | Oracle接続時の認証 |  
| `DB_CONNECT` | データベースサーバーの接続情報 | どのデータベースに接続するか |

#### 💡 設定値の確認方法
- **システム管理者から入手**: 接続情報一式を確認
- **既存システムから確認**: 他のツールで使用している接続情報を参考
- **テスト方法**: コマンドプロンプトで `sqlplus ユーザー名/パスワード@接続文字列` を実行

4. **保存**: `Ctrl+S` で保存

---

### ステップ3: SQLファイルの調整【重要】
**ファイル**: `export_terminal.sql`

#### 📝 修正手順
1. `export_terminal.sql` を **右クリック** → **編集** でファイルを開く
2. **★★★で囲まれた設定部分** を探す
3. **<<<>>>で囲まれた部分** を実際のカラム名・テーブル名に置き換える

#### 🔍 修正箇所の詳細

**A. テーブル名の変更**
```sql
FROM <<<MST_Terminal>>>
```
↓ 例: 実際のテーブル名が `TERMINAL_MASTER` の場合
```sql  
FROM TERMINAL_MASTER
```

**B. カラム名の変更** (各カラムを実際のカラム名に変更)
```sql
<<<terminal_id>>> || ',' ||        -- 端末IDのカラム名
<<<terminal_name>>> || ',' ||      -- 端末名のカラム名  
<<<app_code>>> || ',' ||           -- アプリコードのカラム名
<<<area>>> || ',' ||               -- エリアのカラム名
<<<team_name>>> || ',' ||          -- チーム名のカラム名
TO_CHAR(<<<update_timestamp>>>, 'YYYY-MM-DD HH24:MI:SS')  -- 更新日時のカラム名
```

#### 📋 修正例（実際のテーブル構造に合わせて）
**修正前**:
```sql
SELECT 
    <<<terminal_id>>> || ',' ||
    <<<terminal_name>>> || ',' ||
    -- ... 以下同様
FROM <<<MST_Terminal>>>
ORDER BY <<<terminal_id>>>;
```

**修正後の例**:
```sql
SELECT 
    device_id || ',' ||
    device_name || ',' ||
    application_code || ',' ||
    location || ',' ||
    department || ',' ||
    TO_CHAR(last_update_date, 'YYYY-MM-DD HH24:MI:SS')
FROM TERMINAL_MASTER  
ORDER BY device_id;
```

#### 📊 カラム数とVBA設定の連携
**重要**: SQLで出力するカラム数は、VBAの `COMPARE_COLUMN_COUNT` と一致させる必要があります。

- SQLで6個のカラムを出力 → VBAの `COMPARE_COLUMN_COUNT = 6`
- SQLで8個のカラムを出力 → VBAの `COMPARE_COLUMN_COUNT = 8`

4. **保存**: `Ctrl+S` で保存

---

### ステップ4: VBA設定の調整【必要に応じて】
**ファイル**: `VBA_Code_for_import_master.vbs` (後でExcelにコピー)

#### 📝 修正が必要な場合
現場のテーブル構造やファイル名が異なる場合のみ修正してください。

#### 🔍 主な修正箇所

**A. カラム数の調整**
```vba
Const COMPARE_COLUMN_COUNT As Integer = 6
' ↑ SQLファイルで出力するカラム数と合わせる
```

**修正例**: SQLで8個のカラムを出力する場合
```vba
Const COMPARE_COLUMN_COUNT As Integer = 8
```

**B. ファイル名の変更** (必要な場合のみ)
```vba
Const MASTER_BEFORE_FILE As String = "terminal_master_before.xlsx"
' ↑ 更新前ファイル名を変更したい場合
```

**C. ハイライト色の変更** (必要な場合のみ)
```vba
Const HIGHLIGHT_COLOR_R As Integer = 255  ' 赤色成分
Const HIGHLIGHT_COLOR_G As Integer = 255  ' 緑色成分  
Const HIGHLIGHT_COLOR_B As Integer = 0    ' 青色成分
' 現在: 黄色 (255,255,0)
```

色の変更例:
- **赤色**: `R=255, G=0, B=0`
- **青色**: `R=0, G=0, B=255`  
- **緑色**: `R=0, G=255, B=0`

#### 📋 各設定が反映される処理
| 設定項目 | 反映される処理 |
|---------|---------------|
| `COMPARE_COLUMN_COUNT` | 差分比較で比較するカラム数 |
| ファイル名設定 | 自動保存されるファイル名 |
| 色設定 | 差分比較結果のハイライト色 |
| `DEBUG_MODE` | エラー時の詳細情報表示 |

---

## 📊 Excelブックの作成

### ステップ5: マクロ付きExcelブックの準備

#### 5-1. 新しいExcelブックを作成
1. **Excel** を起動
2. **新しいブック** を作成
3. **ファイル** → **名前を付けて保存**
4. **ファイル名**: `import_master.xlsm`
5. **ファイルの種類**: `Excel マクロ有効ブック (*.xlsm)`
6. **保存場所**: `AutoDB_Processor` フォルダ内

#### 5-2. VBAコードの追加
1. **Alt + F11** を押してVBAエディターを開く
2. **挿入** → **標準モジュール** をクリック
3. **VBA_Code_for_import_master.vbs** をメモ帳で開く
4. **全内容をコピー** (Ctrl+A → Ctrl+C)
5. VBAエディターの**右側の画面にペースト** (Ctrl+V)
6. **Ctrl + S** で保存
7. **Alt + F11** でVBAエディターを閉じる

#### 🔍VBAコード内の設定確認
VBAコードをコピーした後、設定が現場に合っているか確認:

**確認すべき設定**:
```vba
' 📊 カラム数設定 - SQLファイルのカラム数と一致させる
Const COMPARE_COLUMN_COUNT As Integer = 6

' 📁 ファイル名設定 - 必要に応じて変更  
Const MASTER_BEFORE_FILE As String = "terminal_master_before.xlsx"
Const MASTER_AFTER_FILE As String = "terminal_master_after.xlsx"
```

#### 5-3. ワークシートの準備
1. **シート名** を以下に変更:
   - Sheet1 → `制御パネル`
   - Sheet2 → `ヒアリング情報`
2. 必要に応じて新しいシートを**右クリック** → **挿入** で追加

#### 📋 各シートの用途
| シート名 | 用途 | 自動作成される内容 |
|---------|------|------------------|
| `制御パネル` | ツールの操作メニュー | ボタン一覧、使用手順 |
| `ヒアリング情報` | 取り込まれたデータ表示 | 項目名と値の一覧 |

---

## 🚀 動作テスト

### ステップ5: 初回テスト実行

#### 5-1. バッチファイルのテスト
1. `export_terminal.bat` を**ダブルクリック**
2. 以下のような画面が表示されることを確認:
```
========================================
端末マスタ情報エクスポート処理開始
開始時刻: [2024/01/01 10:00:00]
========================================
```

3. **成功した場合**: `AutoDB_output\mst_terminal.csv` が作成される
4. **失敗した場合**: エラーメッセージを確認し、設定を見直す

#### 5-2. Excelマクロのテスト
1. `import_master.xlsm` を開く
2. **開発** タブ → **マクロ** をクリック
3. `InitializeWorkbook` を選択して **実行**
4. 制御パネルが正しく表示されることを確認

---

## 🔧 よくあるトラブルと対処法

### Q1: バッチファイルで「データベースに接続できません」エラー
**症状**: `export_terminal.bat` 実行時にエラーが発生
**原因**: データベース接続設定の間違い

**対処法**:
1. **設定値の確認**:
   ```batch
   set DB_USER=<<<your_username>>>  ← この部分が変更されているか
   set DB_PASS=<<<your_password>>>  ← パスワードが正しいか
   set DB_CONNECT=<<<your_server:1521/your_service>>>  ← 接続文字列が正しいか
   ```

2. **設定値のテスト**:
   コマンドプロンプトで以下を実行:
   ```cmd
   sqlplus ユーザー名/パスワード@接続文字列
   ```

3. **よくある間違い**:
   - `<<<>>>` が残っている → 実際の値に置き換える
   - パスワードに特殊文字が含まれている → `"`で囲む
   - サーバー名の間違い → システム管理者に確認

### Q2: SQLファイルで「テーブルまたはビューが存在しません」エラー
**症状**: CSVファイルが作成されない、またはエラーログにテーブルエラー
**原因**: SQLファイル内のテーブル名・カラム名の間違い

**対処法**:
1. **テーブル名の確認**:
   ```sql
   FROM <<<MST_Terminal>>>  ← この部分が実際のテーブル名に変更されているか
   ```

2. **カラム名の確認**:
   ```sql
   <<<terminal_id>>>  ← 実際のカラム名に変更されているか
   ```

3. **確認方法**:
   - システム管理者にテーブル構造を確認
   - 既存のSQLを参考にする
   - SQL*Plusで直接 `DESC テーブル名` を実行

### Q3: VBAで「型が一致しません」エラー
**症状**: Excel処理実行時にエラーが発生
**原因**: VBAの設定値とSQLの出力が一致していない

**対処法**:
1. **カラム数の確認**:
   ```vba
   Const COMPARE_COLUMN_COUNT As Integer = 6  ← SQLのカラム数と一致しているか
   ```

2. **SQLとの整合性チェック**:
   - SQLで出力されるカラム数をカウント
   - VBAの `COMPARE_COLUMN_COUNT` と一致させる

### Q4: Excelでマクロが実行できない
**症状**: 「マクロが無効になっています」
**対処法**:
1. **マクロ設定の変更**:
   - **ファイル** → **オプション** → **セキュリティセンター**
   - **マクロの設定** → **すべてのマクロを有効にする**
   - Excelを再起動

2. **ファイル形式の確認**:
   - `.xlsm` 形式で保存されているか確認
   - `.xlsx` の場合はマクロが保存されない

### Q5: CSVファイルが文字化けする
**症状**: 日本語が「???」で表示される
**対処法**:
1. **Excel での正しい開き方**:
   - **データ** → **テキストファイル** から開く
   - **文字コード** を **Shift_JIS** に設定

2. **根本的な解決**:
   - VBAの「CSV→Excel変換」機能を使用する

### Q6: 「<<<>>>」エラーが表示される
**症状**: 設定ファイル実行時に `<<<` や `>>>` に関するエラー
**原因**: 設定値の置き換えが完了していない

**対処法**:
1. **設定ファイルの確認**:
   - すべての `<<<項目名>>>` が実際の値に置き換えられているか確認
   - 特に以下のファイルをチェック:
     - `export_terminal.bat` の接続設定
     - `export_terminal.sql` のテーブル名・カラム名

2. **置き換え忘れチェック**:
   ```batch
   # 悪い例（置き換え忘れ）
   set DB_USER=<<<your_username>>>
   
   # 良い例（正しく置き換え済み）
   set DB_USER=terminal_user
   ```

### Q7: 差分比較で結果が正しく表示されない
**症状**: 差分があるはずなのに「差分なし」と表示される
**原因**: カラム数の設定ミス

**対処法**:
1. **設定の確認**:
   ```vba
   Const COMPARE_COLUMN_COUNT As Integer = 6
   ```
   
2. **実際のカラム数との照合**:
   - CSVファイルを開いてカラム数を確認
   - SQLファイルの出力カラム数と一致させる

---

## 📞 サポート

### 問い合わせ前の確認事項
- [ ] このガイドの手順を全て実行したか
- [ ] エラーメッセージを正確に記録したか
- [ ] ファイルの配置に間違いがないか
- [ ] 設定値が正しいか

### 連絡先
- **システム管理者**: [連絡先を記入]
- **内線**: [番号を記入]
- **メール**: [アドレスを記入]

### 問い合わせ時に伝えること
1. **何をしようとしたか**
2. **どのような操作をしたか**
3. **どのようなエラーが発生したか**
4. **エラーメッセージの内容** (スクリーンショット推奨)

---

## 📚 参考資料

### 関連ドキュメント
- `README.md` - 詳細な技術仕様
- `config.txt` - 設定項目の説明
- `sample_hearing_sheet.txt` - ヒアリングシートの例

### 操作手順書
基本的な使い方は以下の順序で実行:
1. `export_terminal.bat` でデータ取得
2. Excel で「CSV→Excel変換」
3. 手動でDB更新作業
4. 再度 `export_terminal.bat` でデータ取得
5. Excel で「差分比較実行」

---

**🎉 セットアップ完了！** 

困ったときは、このガイドを見返すか、システム管理者に相談してください。 